name: Manual Backfill

on:
  workflow_dispatch:
    inputs:
      metric:
        description: 'Specific metric to run (leave empty for all)'
        required: false
        type: string
      user_id:
        description: 'Specific user ID (leave empty for all)'
        required: false
        type: string
      start_date:
        description: 'Start date (YYYY-MM-DD, defaults to 24 hours ago)'
        required: false
        type: string
      end_date:
        description: 'End date (YYYY-MM-DD, defaults to now)'
        required: false
        type: string

env:
  AWS_REGION: us-west-2

jobs:
  invoke:
    name: Backfill Metrics Data
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Display run parameters
        run: |
          echo "### Backfill Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **User ID**: ${{ inputs.user_id || 'all users' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Metric**: ${{ inputs.metric || 'all metrics' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Start Date**: ${{ inputs.start_date || 'from last run' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **End Date**: ${{ inputs.end_date || 'now' }}" >> $GITHUB_STEP_SUMMARY

      - name: Invoke Lambda
        run: |
          PAYLOAD='{}'
          if [ -n "${{ inputs.metric }}" ]; then
            PAYLOAD=$(echo $PAYLOAD | jq -c --arg m "${{ inputs.metric }}" '. + {metric: $m}')
          fi
          if [ -n "${{ inputs.user_id }}" ]; then
            PAYLOAD=$(echo $PAYLOAD | jq -c --arg u "${{ inputs.user_id }}" '. + {user_id: $u}')
          fi
          if [ -n "${{ inputs.start_date }}" ]; then
            PAYLOAD=$(echo $PAYLOAD | jq -c --arg s "${{ inputs.start_date }}" '. + {start_date: $s}')
          fi
          if [ -n "${{ inputs.end_date }}" ]; then
            PAYLOAD=$(echo $PAYLOAD | jq -c --arg e "${{ inputs.end_date }}" '. + {end_date: $e}')
          fi
          
          echo "Invoking Lambda with payload: $PAYLOAD"
          
          aws lambda invoke \
            --function-name life-stats \
            --payload "$PAYLOAD" \
            --cli-binary-format raw-in-base64-out \
            response.json
          
          echo "Lambda Response:"
          cat response.json | jq .

      - name: Upload response
        uses: actions/upload-artifact@v4
        with:
          name: lambda-response
          path: response.json
